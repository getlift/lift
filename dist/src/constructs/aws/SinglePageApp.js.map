{
  "version": 3,
  "sources": ["../../../../src/constructs/aws/SinglePageApp.ts"],
  "sourcesContent": ["import * as cloudfront from \"aws-cdk-lib/aws-cloudfront\";\nimport { FunctionEventType } from \"aws-cdk-lib/aws-cloudfront\";\nimport type { Construct as CdkConstruct } from \"constructs\";\nimport type { AwsProvider } from \"@lift/providers\";\nimport { redirectToMainDomain } from \"../../classes/cloudfrontFunctions\";\nimport { getCfnFunctionAssociations } from \"../../utils/getDefaultCfnFunctionAssociations\";\nimport { ensureNameMaxLength } from \"../../utils/naming\";\nimport type { CommonStaticWebsiteConfiguration } from \"./abstracts/StaticWebsiteAbstract\";\nimport { COMMON_STATIC_WEBSITE_DEFINITION, StaticWebsiteAbstract } from \"./abstracts/StaticWebsiteAbstract\";\n\nexport class SinglePageApp extends StaticWebsiteAbstract {\n    public static type = \"single-page-app\";\n    public static schema = COMMON_STATIC_WEBSITE_DEFINITION;\n\n    constructor(\n        scope: CdkConstruct,\n        protected readonly id: string,\n        protected readonly configuration: CommonStaticWebsiteConfiguration,\n        protected readonly provider: AwsProvider\n    ) {\n        super(scope, id, configuration, provider);\n\n        const cfnDistribution = this.distribution.node.defaultChild as cloudfront.CfnDistribution;\n        const requestFunction = this.createRequestFunction();\n\n        const defaultBehaviorFunctionAssociations = getCfnFunctionAssociations(cfnDistribution);\n\n        cfnDistribution.addOverride(\"Properties.DistributionConfig.DefaultCacheBehavior.FunctionAssociations\", [\n            ...defaultBehaviorFunctionAssociations,\n            { EventType: FunctionEventType.VIEWER_REQUEST, FunctionARN: requestFunction.functionArn },\n        ]);\n    }\n\n    private createRequestFunction(): cloudfront.Function {\n        let additionalCode = \"\";\n\n        if (this.configuration.redirectToMainDomain === true) {\n            additionalCode += redirectToMainDomain(this.domains);\n        }\n\n        /**\n         * CloudFront function that redirects nested paths to /index.html and\n         * let static files pass.\n         *\n         * Files extensions list taken from: https://docs.aws.amazon.com/amplify/latest/userguide/redirects.html#redirects-for-single-page-web-apps-spa\n         * Add pdf and xml as well\n         */\n        const code = `var REDIRECT_REGEX = /^[^.]+$|\\\\.(?!(css|gif|ico|jpg|jpeg|js|png|txt|svg|woff|woff2|ttf|map|json|xml|pdf)$)([^.]+$)/;\n\nfunction handler(event) {\n    var uri = event.request.uri;\n    var request = event.request;\n    var isUriToRedirect = REDIRECT_REGEX.test(uri);\n\n    if (isUriToRedirect) {\n        request.uri = \"/index.html\";\n    }${additionalCode}\n\n    return event.request;\n}`;\n\n        const functionName = ensureNameMaxLength(\n            `${this.provider.stackName}-${this.provider.region}-${this.id}-request`,\n            64\n        );\n\n        return new cloudfront.Function(this, \"RequestFunction\", {\n            functionName,\n            code: cloudfront.FunctionCode.fromInline(code),\n        });\n    }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA,iBAA4B;AAC5B,4BAAkC;AAGlC,iCAAqC;AACrC,+CAA2C;AAC3C,oBAAoC;AAEpC,mCAAwE;AAEjE,4BAA4B,mDAAsB;AAAA,EAIrD,YACI,OACmB,IACA,eACA,UACrB;AACE,UAAM,OAAO,IAAI,eAAe;AAJb;AACA;AACA;AAInB,UAAM,kBAAkB,KAAK,aAAa,KAAK;AAC/C,UAAM,kBAAkB,KAAK;AAE7B,UAAM,sCAAsC,yEAA2B;AAEvE,oBAAgB,YAAY,2EAA2E;AAAA,MACnG,GAAG;AAAA,MACH,EAAE,WAAW,wCAAkB,gBAAgB,aAAa,gBAAgB;AAAA;AAAA;AAAA,EAI5E,wBAA6C;AACjD,QAAI,iBAAiB;AAErB,QAAI,KAAK,cAAc,yBAAyB,MAAM;AAClD,wBAAkB,qDAAqB,KAAK;AAAA;AAUhD,UAAM,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OASd;AAAA;AAAA;AAAA;AAKC,UAAM,eAAe,uCACjB,GAAG,KAAK,SAAS,aAAa,KAAK,SAAS,UAAU,KAAK,cAC3D;AAGJ,WAAO,IAAI,WAAW,SAAS,MAAM,mBAAmB;AAAA,MACpD;AAAA,MACA,MAAM,WAAW,aAAa,WAAW;AAAA;AAAA;AAAA;AAzDnC,AADX,cACW,OAAO;AACP,AAFX,cAEW,SAAS;",
  "names": []
}
