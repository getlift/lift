{
  "version": 3,
  "sources": ["../../../test/unit/permissions.test.ts"],
  "sourcesContent": ["import { get, merge } from \"lodash\";\nimport { pluginConfigExt, runServerless } from \"../utils/runServerless\";\n\ntype CfTemplate = {\n    Resources: Record<string, unknown>;\n    Outputs?: Record<string, unknown>;\n};\n\nfunction expectLiftStorageStatementIsAdded(cfTemplate: CfTemplate) {\n    expect(get(cfTemplate.Resources.IamRoleLambdaExecution, \"Properties.Policies[0].PolicyDocument.Statement\")).toEqual(\n        expect.arrayContaining([\n            expect.objectContaining({\n                Effect: \"Allow\",\n                Action: [\"s3:PutObject\", \"s3:GetObject\", \"s3:DeleteObject\", \"s3:ListBucket\"],\n            }),\n        ])\n    );\n}\n\nfunction expectUserDynamoStatementIsAdded(cfTemplate: CfTemplate) {\n    expect(\n        get(cfTemplate.Resources.IamRoleLambdaExecution, \"Properties.Policies[0].PolicyDocument.Statement\")\n    ).toContainEqual({\n        Effect: \"Allow\",\n        Action: [\"dynamodb:PutItem\"],\n        Resource: \"arn:aws:dynamodb:us-east-1:123456789012:table/myDynamoDBTable\",\n    });\n}\n\ndescribe(\"permissions\", () => {\n    it(\"should not override user-defined role\", async () => {\n        const { cfTemplate } = await runServerless({\n            fixture: \"permissions\",\n            configExt: merge({}, pluginConfigExt, {\n                provider: {\n                    iam: {\n                        role: \"arn:aws:iam::123456789012:role/role\",\n                    },\n                },\n            }),\n            command: \"package\",\n        });\n        expect(cfTemplate.Resources.FooLambdaFunction).toMatchObject({\n            Properties: {\n                Role: \"arn:aws:iam::123456789012:role/role\",\n            },\n        });\n    });\n\n    it(\"should append permissions when using iam.role.statements\", async () => {\n        const { cfTemplate } = await runServerless({\n            fixture: \"permissions\",\n            configExt: merge({}, pluginConfigExt, {\n                provider: {\n                    iam: {\n                        role: {\n                            statements: [\n                                {\n                                    Effect: \"Allow\",\n                                    Action: [\"dynamodb:PutItem\"],\n                                    Resource: \"arn:aws:dynamodb:us-east-1:123456789012:table/myDynamoDBTable\",\n                                },\n                            ],\n                        },\n                    },\n                },\n            }),\n            command: \"package\",\n        });\n\n        expectUserDynamoStatementIsAdded(cfTemplate);\n        expectLiftStorageStatementIsAdded(cfTemplate);\n    });\n\n    it(\"should append permissions when using the deprecated iamRoleStatements\", async () => {\n        const { cfTemplate } = await runServerless({\n            fixture: \"permissions\",\n            configExt: merge({}, pluginConfigExt, {\n                provider: {\n                    iamRoleStatements: [\n                        {\n                            Effect: \"Allow\",\n                            Action: [\"dynamodb:PutItem\"],\n                            Resource: \"arn:aws:dynamodb:us-east-1:123456789012:table/myDynamoDBTable\",\n                        },\n                    ],\n                },\n            }),\n            command: \"package\",\n        });\n\n        expectUserDynamoStatementIsAdded(cfTemplate);\n        expectLiftStorageStatementIsAdded(cfTemplate);\n    });\n\n    it(\"should add permissions when no custom statements are provided\", async () => {\n        const { cfTemplate } = await runServerless({\n            fixture: \"permissions\",\n            configExt: pluginConfigExt,\n            command: \"package\",\n        });\n\n        expectLiftStorageStatementIsAdded(cfTemplate);\n    });\n\n    it(\"should be possible to disable automatic permissions\", async () => {\n        const { cfTemplate } = await runServerless({\n            fixture: \"permissions\",\n            configExt: merge({}, pluginConfigExt, {\n                // We disable automatic permissions\n                lift: {\n                    automaticPermissions: false,\n                },\n            }),\n            command: \"package\",\n        });\n        // There should be no \"s3:*\" permissions added\n        expect(\n            get(cfTemplate.Resources.IamRoleLambdaExecution, \"Properties.Policies[0].PolicyDocument.Statement\")\n        ).toMatchObject([\n            {\n                Action: [\"logs:CreateLogStream\", \"logs:CreateLogGroup\"],\n            },\n            {\n                Action: [\"logs:PutLogEvents\"],\n            },\n        ]);\n    });\n});\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA,oBAA2B;AAC3B,2BAA+C;AAO/C,2CAA2C,YAAwB;AAC/D,SAAO,uBAAI,WAAW,UAAU,wBAAwB,oDAAoD,QACxG,OAAO,gBAAgB;AAAA,IACnB,OAAO,iBAAiB;AAAA,MACpB,QAAQ;AAAA,MACR,QAAQ,CAAC,gBAAgB,gBAAgB,mBAAmB;AAAA;AAAA;AAAA;AAM5E,0CAA0C,YAAwB;AAC9D,SACI,uBAAI,WAAW,UAAU,wBAAwB,oDACnD,eAAe;AAAA,IACb,QAAQ;AAAA,IACR,QAAQ,CAAC;AAAA,IACT,UAAU;AAAA;AAAA;AAIlB,SAAS,eAAe,MAAM;AAC1B,KAAG,yCAAyC,YAAY;AACpD,UAAM,EAAE,eAAe,MAAM,wCAAc;AAAA,MACvC,SAAS;AAAA,MACT,WAAW,yBAAM,IAAI,sCAAiB;AAAA,QAClC,UAAU;AAAA,UACN,KAAK;AAAA,YACD,MAAM;AAAA;AAAA;AAAA;AAAA,MAIlB,SAAS;AAAA;AAEb,WAAO,WAAW,UAAU,mBAAmB,cAAc;AAAA,MACzD,YAAY;AAAA,QACR,MAAM;AAAA;AAAA;AAAA;AAKlB,KAAG,4DAA4D,YAAY;AACvE,UAAM,EAAE,eAAe,MAAM,wCAAc;AAAA,MACvC,SAAS;AAAA,MACT,WAAW,yBAAM,IAAI,sCAAiB;AAAA,QAClC,UAAU;AAAA,UACN,KAAK;AAAA,YACD,MAAM;AAAA,cACF,YAAY;AAAA,gBACR;AAAA,kBACI,QAAQ;AAAA,kBACR,QAAQ,CAAC;AAAA,kBACT,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAOlC,SAAS;AAAA;AAGb,qCAAiC;AACjC,sCAAkC;AAAA;AAGtC,KAAG,yEAAyE,YAAY;AACpF,UAAM,EAAE,eAAe,MAAM,wCAAc;AAAA,MACvC,SAAS;AAAA,MACT,WAAW,yBAAM,IAAI,sCAAiB;AAAA,QAClC,UAAU;AAAA,UACN,mBAAmB;AAAA,YACf;AAAA,cACI,QAAQ;AAAA,cACR,QAAQ,CAAC;AAAA,cACT,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA,MAK1B,SAAS;AAAA;AAGb,qCAAiC;AACjC,sCAAkC;AAAA;AAGtC,KAAG,iEAAiE,YAAY;AAC5E,UAAM,EAAE,eAAe,MAAM,wCAAc;AAAA,MACvC,SAAS;AAAA,MACT,WAAW;AAAA,MACX,SAAS;AAAA;AAGb,sCAAkC;AAAA;AAGtC,KAAG,uDAAuD,YAAY;AAClE,UAAM,EAAE,eAAe,MAAM,wCAAc;AAAA,MACvC,SAAS;AAAA,MACT,WAAW,yBAAM,IAAI,sCAAiB;AAAA,QAElC,MAAM;AAAA,UACF,sBAAsB;AAAA;AAAA;AAAA,MAG9B,SAAS;AAAA;AAGb,WACI,uBAAI,WAAW,UAAU,wBAAwB,oDACnD,cAAc;AAAA,MACZ;AAAA,QACI,QAAQ,CAAC,wBAAwB;AAAA;AAAA,MAErC;AAAA,QACI,QAAQ,CAAC;AAAA;AAAA;AAAA;AAAA;",
  "names": []
}
